import{Fragment,h}from"@stencil/core";import{onFirstVisible}from"../../../../functions/lazy";import{__}from"@wordpress/i18n";import apiFetch from"../../../../functions/fetch";import{addQueryArgs}from"@wordpress/url";export class ScLicense{constructor(){this.deleteActivation=async()=>{try{this.busy=!0,await apiFetch({path:`surecart/v1/activations/${this.selectedActivationId}`,method:"DELETE"}),this.onCloseDeleteModal(),await this.initialFetch()}catch(e){console.error(e),this.deleteActivationError=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.busy=!1}},this.onCloseDeleteModal=()=>{this.selectedActivationId="",this.showConfirmDelete=!1,this.busy=!1,this.deleteActivationError=""},this.licenseId=void 0,this.loading=!1,this.error="",this.license=void 0,this.activations=[],this.copied=!1,this.showConfirmDelete=!1,this.selectedActivationId="",this.deleteActivationError="",this.busy=!1,this.pagination={total:0,total_pages:0},this.query={page:1,per_page:10}}nextPage(){this.query.page=this.query.page+1,this.fetchActivations()}prevPage(){this.query.page=this.query.page-1,this.fetchActivations()}componentWillLoad(){onFirstVisible(this.el,(()=>{this.initialFetch()}))}async fetchActivations(){try{this.loading=!0,await this.getActivations()}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.loading=!1}}async initialFetch(){try{this.loading=!0,await Promise.all([this.getLicense(),this.getActivations()])}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.loading=!1}}async getLicense(){this.license=await apiFetch({path:addQueryArgs(`surecart/v1/licenses/${this.licenseId}`,{expand:["purchase","purchase.product"]})})}async getActivations(){const e=await apiFetch({path:addQueryArgs("surecart/v1/activations",{license_ids:[this.licenseId],...this.query}),parse:!1});this.pagination={total:parseInt(e.headers.get("X-WP-Total")),total_pages:parseInt(e.headers.get("X-WP-TotalPages"))},this.activations=await e.json()}async copyKey(e){try{await navigator.clipboard.writeText(e),this.copied=!0,setTimeout((()=>{this.copied=!1}),2e3)}catch(e){console.error(e),alert(__("Error copying to clipboard","surecart"))}}renderStatus(){var e,t,i,s;return"active"===(null===(e=this.license)||void 0===e?void 0:e.status)?h("sc-tag",{type:"success"},__("Active","surecart")):"revoked"===(null===(t=this.license)||void 0===t?void 0:t.status)?h("sc-tag",{type:"danger"},__("Revoked","surecart")):"inactive"===(null===(i=this.license)||void 0===i?void 0:i.status)?h("sc-tag",{type:"info"},__("Inactive","surecart")):h("sc-tag",{type:"info"},null===(s=this.license)||void 0===s?void 0:s.status)}renderLoading(){return h("sc-dashboard-module",null,h("span",{slot:"heading"},h("sc-skeleton",{style:{width:"120px"}})),h("sc-card",null,h("sc-stacked-list",null,h("sc-flex",{flexDirection:"column",style:{gap:"1em"}},h("sc-skeleton",{style:{width:"20%",display:"inline-block"}}),h("sc-skeleton",{style:{width:"60%",display:"inline-block"}}),h("sc-skeleton",{style:{width:"40%",display:"inline-block"}})))))}renderEmpty(){return h("sc-empty",{icon:"activity"},__("License not found.","surecart"))}renderLicenseHeader(){var e;const t=null===(e=this.license)||void 0===e?void 0:e.purchase,i=null==t?void 0:t.product;return h(Fragment,null,h("span",{slot:"heading"},h("div",{class:"license__heading"},null==i?void 0:i.name,!this.loading&&!t.live_mode&&h("sc-tag",{type:"warning",size:"small"},__("Test Mode","surecart")))))}renderContent(){var e,t,i,s,n,a,l,o,r;return this.loading&&!(null===(e=this.license)||void 0===e?void 0:e.id)?this.renderLoading():(null===(t=this.license)||void 0===t?void 0:t.id)?h(Fragment,null,h("sc-dashboard-module",{error:this.error},this.renderLicenseHeader(),h("sc-card",{noPadding:!0},h("sc-stacked-list",null,h("sc-stacked-list-row",{style:{"--columns":"2","--sc-stacked-list-row-align-items":"center"}},h("div",null,__("License Status","surecart")),this.renderStatus()),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("License Key","surecart")),h("div",{class:"license__key"},h("sc-input",{value:null===(i=this.license)||void 0===i?void 0:i.key,readonly:!0},h("sc-button",{class:"license__copy",type:"default",size:"small",slot:"suffix",onClick:()=>{var e;return this.copyKey(null===(e=this.license)||void 0===e?void 0:e.key)}},this.copied?__("Copied!","surecart"):__("Copy","surecart"))))),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("Date","surecart")),h("span",null,null===(s=this.license)||void 0===s?void 0:s.created_at_date)),h("sc-stacked-list-row",{style:{"--columns":"2"}},h("div",null,__("Activations Count","surecart")),h("span",null,null===(n=this.license)||void 0===n?void 0:n.activation_count," / ",(null===(a=this.license)||void 0===a?void 0:a.activation_limit)||h("span",null,"âˆž")))))),h("sc-dashboard-module",null,h("span",{slot:"heading"},h("slot",{name:"heading"},__("Activations","surecart"))),h("sc-card",{noPadding:!0},(null===(l=this.activations)||void 0===l?void 0:l.length)?h("sc-stacked-list",null,this.activations.map((e=>h("sc-stacked-list-row",{style:{"--columns":"4"}},h("div",{class:"license__date"},e.created_at_date),h("div",null,e.name),h("div",null,e.fingerprint),h("div",null,h("sc-button",{size:"small",onClick:()=>{this.selectedActivationId=e.id,this.showConfirmDelete=!0}},__("Delete","surecart"))))))):h("sc-empty",null,__("No activations present.","surecart")),this.loading&&h("sc-block-ui",{style:{"--sc-block-ui-opacity":"0.75"},spinner:!0})),(null===(o=this.pagination)||void 0===o?void 0:o.total_pages)>1&&h("sc-pagination",{page:this.query.page,perPage:this.query.per_page,total:this.pagination.total,totalPages:this.pagination.total_pages,totalShowing:null===(r=null==this?void 0:this.activations)||void 0===r?void 0:r.length,onScNextPage:()=>this.nextPage(),onScPrevPage:()=>this.prevPage()}))):this.renderEmpty()}renderConfirmDelete(){return h("sc-dialog",{open:this.showConfirmDelete,style:{"--body-spacing":"var(--sc-spacing-x-large)"},noHeader:!0,onScRequestClose:this.onCloseDeleteModal},h("sc-button",{class:"close__button",type:"text",circle:!0,onClick:this.onCloseDeleteModal,disabled:this.loading},h("sc-icon",{name:"x"})),h("sc-dashboard-module",{heading:__("Delete Activation","surecart"),class:"license-cancel",error:this.error,style:{"--sc-dashboard-module-spacing":"1em"}},h("span",{slot:"description"},__("Are you sure you want to delete activation?","surecart")),h("sc-flex",{justifyContent:"flex-start"},h("sc-button",{type:"primary",disabled:this.loading||this.busy,onClick:this.deleteActivation},__("Delete Activation","surecart")),h("sc-button",{style:{color:"var(--sc-color-gray-500"},type:"text",onClick:this.onCloseDeleteModal,disabled:this.loading||this.busy},__("Cancel","surecart"))),this.busy&&h("sc-block-ui",{style:{"--sc-block-ui-opacity":"0.75"},spinner:!0})))}render(){return h("sc-spacing",{key:"c4ec74570eb30fc9ad2a29dc2b82392942528028",style:{"--spacing":"var(--sc-spacing-large)"}},this.renderContent(),this.renderConfirmDelete())}static get is(){return"sc-license"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["sc-license.scss"]}}static get styleUrls(){return{$:["sc-license.css"]}}static get properties(){return{licenseId:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"The license id"},attribute:"license-id",reflect:!1},query:{type:"unknown",mutable:!0,complexType:{original:"{\n    page: number;\n    per_page: number;\n  }",resolved:"{ page: number; per_page: number; }",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Query to fetch Activations"},defaultValue:"{\n    page: 1,\n    per_page: 10,\n  }"}}}static get states(){return{loading:{},error:{},license:{},activations:{},copied:{},showConfirmDelete:{},selectedActivationId:{},deleteActivationError:{},busy:{},pagination:{}}}static get elementRef(){return"el"}}