import{h,Host}from"@stencil/core";import{__}from"@wordpress/i18n";import{addQueryArgs}from"@wordpress/url";import apiFetch from"../../../../functions/fetch";import{formatTaxDisplay}from"../../../../functions/tax";export class ScSubscriptionNextPayment{constructor(){this.subscription=void 0,this.updatePaymentMethodUrl=void 0,this.period=void 0,this.loading=!0,this.error=void 0,this.details=void 0}componentWillLoad(){this.fetch()}handleSubscriptionChange(){this.fetch()}async fetch(){var t,i,e;if((null===(t=this.subscription)||void 0===t?void 0:t.cancel_at_period_end)&&this.subscription.current_period_end_at)this.loading=!1;else if("canceled"!==(null===(i=this.subscription)||void 0===i?void 0:i.status))try{this.loading=!0,this.period=await apiFetch({method:"PATCH",path:addQueryArgs(`surecart/v1/subscriptions/${null===(e=this.subscription)||void 0===e?void 0:e.id}/upcoming_period`,{skip_product_group_validation:!0,expand:["period.checkout","checkout.line_items","checkout.payment_method","checkout.manual_payment_method","payment_method.card","payment_method.payment_instrument","payment_method.paypal_account","payment_method.bank_account","line_item.price","price.product","period.subscription"]}),data:{purge_pending_update:!1}})}catch(t){console.error(t),this.error=t}finally{this.loading=!1}else this.loading=!1}render(){var t,i,e,n,o;if(this.loading)return h("sc-toggle",{borderless:!0,disabled:!0},h("sc-flex",{slot:"summary",flexDirection:"column"},h("sc-skeleton",{style:{width:"200px"}}),h("sc-skeleton",{style:{width:"400px"}}),h("sc-skeleton",{style:{width:"300px"}})));const s=null===(t=null==this?void 0:this.period)||void 0===t?void 0:t.checkout;if(!s)return h("div",{style:{padding:"var(--sc-spacing-medium)"}},h("sc-subscription-details",{slot:"summary",subscription:this.subscription}));const l=(null==s?void 0:s.manual_payment)?null==s?void 0:s.manual_payment_method:null,a=(null==this?void 0:this.subscription.payment_method)||(null==this?void 0:this.subscription.manual_payment);return h(Host,null,h("sc-toggle",{borderless:!0,shady:!0},h("span",{slot:"summary"},h("sc-subscription-details",{subscription:this.subscription},h("div",{style:{fontSize:"var(--sc-font-size-small)"}},__("Your next payment is","surecart")," ",h("strong",null,null==s?void 0:s.amount_due_display_amount)," ",!!(null===(i=this.subscription)||void 0===i?void 0:i.remaining_period_text)&&`â€” ${null===(e=this.subscription)||void 0===e?void 0:e.remaining_period_text}`))),h("sc-card",{noPadding:!0,borderless:!0},null===(n=null==s?void 0:s.line_items)||void 0===n?void 0:n.data.map((t=>{var i,e,n,o,s,l,a;return h("sc-product-line-item",{image:null===(e=null===(i=t.price)||void 0===i?void 0:i.product)||void 0===e?void 0:e.line_item_image,name:null===(o=null===(n=t.price)||void 0===n?void 0:n.product)||void 0===o?void 0:o.name,price:null===(s=null==t?void 0:t.price)||void 0===s?void 0:s.name,variant:null==t?void 0:t.variant_display_options,editable:!1,removable:!1,note:null==t?void 0:t.display_note,scratchDisplayAmount:null==t?void 0:t.scratch_display_amount,displayAmount:null==t?void 0:t.subtotal_display_amount,quantity:null==t?void 0:t.quantity,amount:null==t?void 0:t.subtotal_display_amount,interval:`${null===(l=null==t?void 0:t.price)||void 0===l?void 0:l.short_interval_text} ${null===(a=null==t?void 0:t.price)||void 0===a?void 0:a.short_interval_count_text}`,purchasableStatus:null==t?void 0:t.purchasable_status_display})})),h("sc-line-item",null,h("span",{slot:"description"},__("Subtotal","surecart")),null==s?void 0:s.subtotal_display_amount),!!s.proration_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Proration Credit","surecart")),null==s?void 0:s.proration_display_amount),!!s.applied_balance_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Applied Balance","surecart")),null==s?void 0:s.applied_balance_display_amount),!!s.trial_amount&&h("sc-line-item",null,h("span",{slot:"description"},__("Trial","surecart")),null==s?void 0:s.trial_display_amount),!!(null==s?void 0:s.discount_amount)&&h("sc-line-item",null,h("span",{slot:"description"},__("Discounts","surecart")),null==s?void 0:s.discounts_display_amount),!!(null==s?void 0:s.shipping_amount)&&h("sc-line-item",{style:{marginTop:"var(--sc-spacing-small)"}},h("span",{slot:"description"},__("Shipping","surecart")),null==s?void 0:s.shipping_display_amount),!!s.tax_amount&&h("sc-line-item",null,h("span",{slot:"description"},formatTaxDisplay(null==s?void 0:s.tax_label)),null==s?void 0:s.tax_display_amount),h("sc-divider",{style:{"--spacing":"0"}}),h("sc-line-item",null,h("span",{slot:"description"},__("Payment","surecart")),a&&h("a",{href:this.updatePaymentMethodUrl,slot:"price-description"},h("sc-flex",{"justify-content":"flex-start","align-items":"center",style:{"--spacing":"0.5em"}},l?h("sc-manual-payment-method",{paymentMethod:l}):h("sc-payment-method",{paymentMethod:null==s?void 0:s.payment_method}),h("sc-icon",{name:"edit-3"}))),!a&&h("a",{href:addQueryArgs(window.location.href,{action:"create",model:"payment_method",id:null==this?void 0:this.subscription.id,...!1===(null===(o=null==this?void 0:this.subscription)||void 0===o?void 0:o.live_mode)?{live_mode:!1}:{}}),slot:"price-description"},__("Add Payment Method","surecart"))),h("sc-line-item",{style:{"--price-size":"var(--sc-font-size-x-large)"}},h("span",{slot:"title"},__("Total Due","surecart")),h("span",{slot:"price"},null==s?void 0:s.amount_due_display_amount),h("span",{slot:"currency"},s.currency)))))}static get is(){return"sc-subscription-next-payment"}static get encapsulation(){return"shadow"}static get properties(){return{subscription:{type:"unknown",mutable:!1,complexType:{original:"Subscription",resolved:"Subscription",references:{Subscription:{location:"import",path:"../../../../types",id:"src/types.ts::Subscription"}}},required:!1,optional:!1,docs:{tags:[],text:""}},updatePaymentMethodUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Update the payment method url"},attribute:"update-payment-method-url",reflect:!1}}}static get states(){return{period:{},loading:{},error:{},details:{}}}static get watchers(){return[{propName:"subscription",methodName:"handleSubscriptionChange"}]}}